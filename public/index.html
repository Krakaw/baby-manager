<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Baby Monitor</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
          integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
</head>
<body>
<div id="app">
    <div class="container">
        <div class="row">
            <pre>{{castStatusData}}</pre>
            <pre>{{devices}}</pre>
            <pre>{{files}}</pre>

            <div>
                <button type="button" class="btn btn-primary"
                        @click="castUrl(cast)"
                        v-for="(cast, i) in friendlyCastList">
                    {{cast.friendlyFileName}}<br/><i class="fas fa-play"></i><br>{{cast.friendlyDeviceName}}
                </button>
            </div>

        </div>
        <div class="row">
            <div v-for="(stream, i) in streams">
                <render-stream :stream="stream"></render-stream>
            </div>
            <div id="streams"></div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
<script type='text/javascript' src='javascripts/jsmpeg.min.js'></script>
<!-- production version, optimized for size and speed -->
<!--<script src="https://cdn.jsdelivr.net/npm/vue"></script>-->
<!-- development version, includes helpful console warnings -->
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
    const ACTION_CAST_STATUS = 'castStatus'
    const ACTION_CAST_START = 'castStart'
    const ACTION_CAST_LIST = 'castList'
    const ACTION_STREAM_ADD = 'streamAdd'
    const ACTION_STREAM_LIST = 'streamList'
    const ACTION_FILE_LIST = 'fileList'
    const ACTION_DEVICE_LIST = 'deviceList'

    Vue.component('render-stream', {
        props: ['stream'],
        data: () => {
            return {
                player: null
            }
        },
        template: '<canvas ref="canvas"></canvas>',
        mounted() {
            const {streamWsPort} = this.stream
            this.$set(this, 'player', new JSMpeg.Player(`ws://${window.location.hostname}:${streamWsPort}`, {
                canvas: this.$refs.canvas
            }));
        },
        beforeDestroy() {
            this.player.stop()
        }
    })
    const app = new Vue({
        el: '#app',
        data: {
            socket: false,
            casts: [],
            devices: [],
            files: [],
            streams: [],
            players: [],
            castStatusData: {}
        },
        computed: {
            friendlyCastList() {
                let devices = this.devices;
                let deviceMap = {};
                devices.forEach(device => {
                    deviceMap[device.deviceId] = device.friendlyName;
                })
                let casts = this.casts;
                return casts.map(cast => {
                    cast.friendlyFileName = cast.url.split('/').pop()
                    cast.friendlyDeviceName = deviceMap[cast.deviceId]
                    return cast
                })
            },
        },
        methods: {
            castUrl(cast) {
                this.socket.send(JSON.stringify({
                    action: ACTION_CAST_START,
                    url: cast.url,
                    deviceId: cast.deviceId
                }))
            },
            onSocketMessage(e) {
                const data = JSON.parse(e.data);
                if (this[data.action]) {
                    console.log(data.action, data)
                    this[data.action](data);
                }
            },
            [ACTION_DEVICE_LIST](data) {
                this.$set(this, 'devices', data.value)
            },
            [ACTION_CAST_LIST](data) {
                this.$set(this, 'casts', data.value)
            },
            [ACTION_CAST_STATUS](data) {
                this.$set(this.castStatusData, data.value.deviceId, data.value.status)
            },
            [ACTION_FILE_LIST](data) {
                this.$set(this, 'files', data.value)
            },
            [ACTION_STREAM_LIST](data) {
                this.$set(this, 'streams', data.value)
            },
        },
        created() {
            const socket = new WebSocket(`ws://${window.location.host}/ws`);
            socket.onmessage = this.onSocketMessage
            this.$set(this, 'socket', socket)
        }
    })


    let casts = []
    let devices = []
    let files = []
    let streams = []

    let players = [];

    function castFile(url, deviceId) {
        const action = ACTION_CAST_START
        socket.send(JSON.stringify({action, url, deviceId}))
    }

    function fetchDevices() {
        socket.send(JSON.stringify({action: ACTION_DEVICE_LIST}))
    }


    function renderCasts() {
        let castsDiv = document.getElementById('casts');
        castsDiv.innerHTML = ''
        casts.forEach(cast => {
            const button = document.createElement('button')
            button.onclick = function () {
                castFile(cast.url, cast.deviceId)
            }
            let device = devices.find(d => d.host === cast.deviceId)
            let name = device ? device.friendlyName : cast.deviceId;
            button.innerText = `Play ${cast.url.split('/').pop()} on ${name}`
            castsDiv.append(button)
        })
    }


</script>
</body>
</html>